<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bangle.js Data Streaming</title>
    <link rel="stylesheet" href="https://cdn.rawgit.com/kimeiga/bahunya/css/bahunya-0.1.1.css">
</head>
<body>
    <h2 style="text-align: center;">Bangle.js Data Streaming App</h2>
    <main>
        <article>
            <p id="pMain">Ready to connect</p>
            <button id="btnConnect">Connect</button>
            <p>Heart Rate: <span id="pHeartRate"></span></p>
        </article>
    </main>
    <script src="https://www.puck-js.com/puck.js"></script>
    <script src="deps/FileSaver.js"></script>
    <script>
        var result = {
            hr: []
        };

        var startTimestamp;

        var btnConnect = document.getElementById("btnConnect");
        var pMain = document.getElementById("pMain");
        var pHeartRate = document.getElementById("pHeartRate");

        var connection;

        btnConnect.addEventListener("click", function () {
            if (connection) {
                connection.close();
                connection = undefined;
                pMain.textContent = 'Ready to connect';

                var filename = 'testResults_' + Date.now() + '.json';
                var blob = new Blob([JSON.stringify(result)], { type: "application/json;charset=utf-8" });
                saveAs(blob, filename);
                return;
            } else {
                Puck.connect(function (c) {
                    if (!c) return;
                    connection = c;
                    pMain.textContent = 'Connected!';
                    btnConnect.textContent = 'Disconnect';

                    result = {
                        hr: []
                    };
                    startTimestamp = Date.now();

                    connection.on("data", function (d) {
                        processData(d);
                    });

                    connection.write("reset();\n", function () {
                        setTimeout(function () {
                            connection.write("\x03\x10if(1){" + BANGLE_CODE + "}\n", () => {});
                        }, 1500);
                    });
                });
            }
        });

        function processData(data) {
            var lines = data.split("\n");
            lines.forEach(function(line) {
                var parts = line.split(",");
                if (parts.length >= 3) {
                    if (parts[0] === "H") {
                        recordHRData(parts);
                    }
                }
            });
        }

        function recordHRData(data) {
            var hrData = {
                ms: parseInt(data[1]),
                hr: parseInt(data[2])
            };
            result.hr.push(hrData);
            pHeartRate.textContent = hrData.hr;
        }
    </script>
</body>
</html>

