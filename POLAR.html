<html>
<head>
    <title>Polar H10 Heart Rate Data Streaming</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://cdn.rawgit.com/kimeiga/bahunya/css/bahunya-0.1.1.css" />
</head>
<body>
    <h2 style="text-align: center;">Polar H10 Heart Rate Data Streaming</h2>
    <main>
        <article>
            <p id="pMain">Ready to connect</p>
            <button id="btnConnect">Connect</button>
            <p>Heart Rate: <span id="pHeartRate"></span></p>
        </article>
    </main>
    <script>
        // Codice per la connessione e l'acquisizione dei dati dalla Polar H10
        // (Questo Ã¨ solo un esempio generico e potrebbe non funzionare direttamente con la Polar H10)

        let pMain = document.getElementById("pMain");
        let btnConnect = document.getElementById("btnConnect");
        let pHeartRate = document.getElementById("pHeartRate");

        let result = {};

        // When we click the connect button...
        let device;
        btnConnect.addEventListener("click", function () {
            // Disconnect if already connected
            if (device && device.gatt.connected) {
                device.gatt.disconnect();
                device = undefined;
                pMain.textContent = 'Ready to connect';
                return;
            } else {
                // Connect
                connectToPolarH10();
            }
        });

        // Function to connect to Polar H10 via Bluetooth
        async function connectToPolarH10() {
            try {
                pMain.textContent = 'Connecting...';
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'Polar H10', services: ['heart_rate'] }],
                    optionalServices: ['heart_rate'],
                    acceptAllDevices: false,
                    deviceId: 'D316F329' // Specific ID of the Polar H10
                });
                await device.gatt.connect();
                pMain.textContent = 'Connected!';
                setupPolarH10Listener();
            } catch (error) {
                console.error('Error connecting to Polar H10:', error);
                pMain.textContent = 'Error connecting';
            }
        }

        // Setup event listener for heart rate data received from Polar H10
        function setupPolarH10Listener() {
            if (!device || !device.gatt.connected) {
                console.error('Device not connected');
                return;
            }

            device.gatt.getPrimaryService('heart_rate').then(service => {
                service.getCharacteristic('heart_rate_measurement').then(characteristic => {
                    characteristic.addEventListener('characteristicvaluechanged', handleHeartRateData);
                    characteristic.startNotifications();
                });
            }).catch(error => {
                console.error('Error setting up notifications:', error);
            });
        }

        // Function to handle received heart rate data from Polar H10
        function handleHeartRateData(event) {
            let value = event.target.value;
            let heartRate = value.getUint8(1);
            pHeartRate.textContent = heartRate;
        }
    </script>
</body>
</html>

