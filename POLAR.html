<!DOCTYPE html>
<html lang="en">
<head>
    <title>Polar H10 Heart Rate Data Streaming</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://cdn.rawgit.com/kimeiga/bahunya/css/bahunya-0.1.1.css" />
</head>
<body>
    <h2 style="text-align: center;">Polar H10 Heart Rate Data Streaming</h2>
    <main>
        <article>
            <p id="pMain">Ready to connect</p>
            <button id="btnConnect">Connect</button>
            <p>Heart Rate: <span id="pHeartRate"></span></p>
            <button id="btnDownload">Download Data</button>
        </article>
        <!-- Aggiungi un div per il grafico -->
        <div id="graph"></div>
        <!-- Aggiungi un div per visualizzare il valore dell'heart rate corrente -->
        <div id="currentHeartRate"></div>
    </main>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script>
        // Variabili globali per i dati dell'heart rate
        let heartRateData = [];

        // Funzione per creare il grafico di streaming
        function createStreamingGraph() {
            // Configurazione del grafico
            var layout = {
                xaxis: {
                    title: 'Time'
                },
                yaxis: {
                    title: 'Heart Rate'
                },
                showlegend: false
            };

            var config = {
                responsive: true
            };

            // Creazione del grafico vuoto
            var graph = Plotly.newPlot('graph', [], layout, config);

            // Funzione per aggiornare il grafico con i nuovi dati
            function updateGraph(data) {
                // Estrae i timestamp e i valori dell'heart rate dai dati
                var timestamps = data.map(entry => new Date(entry.timestamp).getTime());
                var heartRates = data.map(entry => entry.heartRate);

                // Aggiorna il grafico
                Plotly.relayout('graph', {
                    xaxis: {
                        range: [Math.min(...timestamps), Math.max(...timestamps)]
                    }
                });
                Plotly.restyle('graph', {
                    x: [timestamps],
                    y: [heartRates]
                });
            }

            // Richiama la funzione per aggiornare il grafico con i dati attuali
            updateGraph(heartRateData);
        }

        // Funzione per gestire i dati dell'heart rate ricevuti dalla Polar H10
        function handleHeartRateData(event) {
            let value = event.target.value;
            let heartRate = value.getUint8(1);
            let timestamp = new Date().toISOString();
            let dataEntry = { timestamp: timestamp, heartRate: heartRate };
            heartRateData.push(dataEntry);
            document.getElementById("pHeartRate").textContent = heartRate;
            document.getElementById("currentHeartRate").textContent = "Current Heart Rate: " + heartRate + " bpm";
            createStreamingGraph();
        }

        // Funzione per connettersi alla Polar H10
        async function connectToPolarH10() {
            try {
                document.getElementById("pMain").textContent = 'Scanning for devices...';
                let device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: ['heart_rate'] }],
                    optionalServices: ['heart_rate']
                });
                await device.gatt.connect();
                document.getElementById("pMain").textContent = 'Connected!';
                setupPolarH10Listener(device);
            } catch (error) {
                console.error('Error connecting to Polar H10:', error);
                document.getElementById("pMain").textContent = 'Error connecting';
            }
        }

        // Funzione per configurare il listener per i dati dell'heart rate dalla Polar H10
        function setupPolarH10Listener(device) {
            if (!device || !device.gatt.connected) {
                console.error('Device not connected');
                return;
            }

            device.gatt.getPrimaryService('heart_rate').then(service => {
                service.getCharacteristic('heart_rate_measurement').then(characteristic => {
                    characteristic.addEventListener('characteristicvaluechanged', handleHeartRateData);
                    characteristic.startNotifications();
                });
            }).catch(error => {
                console.error('Error setting up notifications:', error);
            });
        }

        // Gestione del click sul pulsante "Connect"
        document.getElementById("btnConnect").addEventListener("click", function () {
            let btnConnect = document.getElementById("btnConnect");
            if (btnConnect.textContent === "Connect") {
                connectToPolarH10();
                btnConnect.textContent = "Disconnect";
            } else {
                let device = navigator.bluetooth.getDevice();
                device.gatt.disconnect();
                btnConnect.textContent = "Connect";
                document.getElementById("pMain").textContent = "Ready to connect";
            }
        });

        // Gestione del click sul pulsante "Download Data"
        document.getElementById("btnDownload").addEventListener('click', function () {
            let json = JSON.stringify(heartRateData, null, 2);
            let blob = new Blob([json], { type: 'application/json' });
            let url = URL.createObjectURL(blob);

            let a = document.createElement('a');
            a.href = url;
            a.download = 'heart_rate_data.json';
            a.click();

            URL.revokeObjectURL(url);
        });

        // Chiama la funzione per creare il grafico di streaming quando la pagina Ã¨ completamente caricata
        document.addEventListener('DOMContentLoaded', function() {
            createStreamingGraph();
        });
    </script>
</body>
</html>


