<html>
<head>
    <title>Polar H10 Heart Rate Data Streaming</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://cdn.rawgit.com/kimeiga/bahunya/css/bahunya-0.1.1.css" />
</head>
<body>
    <h2 style="text-align: center;">Polar H10 Heart Rate Data Streaming</h2>
    <main>
        <article>
            <p id="pMain">Ready to connect</p>
            <button id="btnConnect">Connect</button>
            <p>Heart Rate: <span id="pHeartRate"></span></p>
        </article>
    </main>
    <script>
        let pMain = document.getElementById("pMain");
        let btnConnect = document.getElementById("btnConnect");
        let pHeartRate = document.getElementById("pHeartRate");

        let device;
        let heartRateData = [];

        btnConnect.addEventListener("click", function () {
            if (device && device.gatt.connected) {
                device.gatt.disconnect();
                device = undefined;
                pMain.textContent = 'Ready to connect';
                return;
            } else {
                connectToPolarH10();
            }
        });

        async function connectToPolarH10() {
            try {
                pMain.textContent = 'Scanning for devices...';
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: ['heart_rate'] }],
                    optionalServices: ['heart_rate']
                });
                await device.gatt.connect();
                pMain.textContent = 'Connected!';
                setupPolarH10Listener();
            } catch (error) {
                console.error('Error connecting to Polar H10:', error);
                pMain.textContent = 'Error connecting';
            }
        }

        function setupPolarH10Listener() {
            if (!device || !device.gatt.connected) {
                console.error('Device not connected');
                return;
            }

            device.gatt.getPrimaryService('heart_rate').then(service => {
                service.getCharacteristic('heart_rate_measurement').then(characteristic => {
                    characteristic.addEventListener('characteristicvaluechanged', handleHeartRateData);
                    characteristic.startNotifications();
                });
            }).catch(error => {
                console.error('Error setting up notifications:', error);
            });
        }

        function handleHeartRateData(event) {
            let value = event.target.value;
            let heartRate = value.getUint8(1);
            pHeartRate.textContent = heartRate;
            heartRateData.push({ timestamp: new Date().toISOString(), heartRate: heartRate });
        }

        window.addEventListener('beforeunload', function () {
            if (device && device.gatt.connected) {
                device.gatt.disconnect();
            }
            if (heartRateData.length > 0) {
                saveHeartRateDataToFile(heartRateData);
            }
        });

        function saveHeartRateDataToFile(data) {
            let json = JSON.stringify(data, null, 2);
            let blob = new Blob([json], { type: 'application/json' });
            let url = URL.createObjectURL(blob);

            let a = document.createElement('a');
            a.href = url;
            a.download = 'heart_rate_data.json';
            a.click();

            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
