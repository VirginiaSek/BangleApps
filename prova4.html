<!DOCTYPE html>
<html>
<head>
    <title>Bangle.js Data Streaming</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://www.puck-js.com/puck.js"></script>
</head>
<body>
    <h2 style="text-align: center;">Bangle.js Data Streaming</h2>
    <main>
        <article>
            <p id="pMain">Ready to connect</p>
            <button id="btnConnect">Connect</button>
            <p>X: <span id="pX"></span></p>
            <p>Y: <span id="pY"></span></p>
            <p>Z: <span id="pZ"></span></p>
            <p>Steps: <span id="pSteps"></span></p>
            <p>Heart Rate: <span id="pHeartRate"></span></p>
        </article>
    </main>
    <script>
        let connection;
        let fileWriter;

        // Funzione per inizializzare la connessione con il dispositivo Bangle.js
        function connect() {
            Puck.connect(function(c) {
                if (!c) {
                    return;
                }
                connection = c;
                document.getElementById("pMain").textContent = 'Connected!';
                document.getElementById("btnConnect").textContent = 'Disconnect';

                // Inizializza il file writer
                navigator.webkitPersistentStorage.requestQuota(1024 * 1024, function(grantedBytes) {
                    window.requestFileSystem(PERSISTENT, grantedBytes, function(fs) {
                        fs.root.getFile('bangle_data.bin', {create: true}, function(fileEntry) {
                            fileEntry.createWriter(function(writer) {
                                fileWriter = writer;
                            }, errorHandler);
                        }, errorHandler);
                    }, errorHandler);
                }, errorHandler);

                // Avvia la ricezione dei dati
                startStreaming();
            });
        }

        // Funzione per avviare la ricezione dei dati dal Bangle.js
        function startStreaming() {
            connection.write("reset();\n", function () {
                setTimeout(function () {
                    connection.write(`
                        var start = Date.now();
                        Bangle.on('accel', function(a) {
                            var d = new Int16Array(4);
                            d[0] = Math.round(a.x * 1000);
                            d[1] = Math.round(a.y * 1000);
                            d[2] = Math.round(a.z * 1000);
                            d[3] = Date.now() - start;
                            fileWriter.write(d.buffer);
                        });

                        Bangle.on('step', function(up) {
                            var d = new Uint16Array(2);
                            d[0] = up ? 1 : 0;
                            d[1] = Date.now() - start;
                            fileWriter.write(d.buffer);
                        });

                        Bangle.setHRMPower(1);
                        Bangle.on('HRM', function(hrm) {
                            var d = new Uint16Array(2);
                            d[0] = hrm.bpm;
                            d[1] = Date.now() - start;
                            fileWriter.write(d.buffer);
                        });
                    `, () => {
                        console.log("Ready...");
                    });
                }, 1500);
            });
        }

        // Funzione per gestire eventuali errori
        function errorHandler(err) {
            console.error('File system error:', err);
        }

        // Funzione per gestire il click sul pulsante di connessione
        document.getElementById("btnConnect").addEventListener("click", function () {
            if (connection) {
                connection.close();
                connection = undefined;
                document.getElementById("pMain").textContent = 'Ready to connect';
                document.getElementById("btnConnect").textContent = 'Connect';
            } else {
                connect();
            }
        });
    </script>
</body>
</html>
